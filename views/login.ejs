<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<link rel="shortcut icon" href="assets/img/favicon/favicon.ico">
	<link rel="icon" sizes="16x16 32x32 64x64" href="assets/img/favicon/favicon.ico">
	<link rel="icon" type="image/png" sizes="196x196" href="assets/img/favicon/favicon-192.png">
	<link rel="icon" type="image/png" sizes="160x160" href="assets/img/favicon/favicon-160.png">
	<link rel="icon" type="image/png" sizes="96x96" href="assets/img/favicon/favicon-96.png">
	<link rel="icon" type="image/png" sizes="64x64" href="assets/img/favicon/favicon-64.png">
	<link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon/favicon-32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon/favicon-16.png">
	<link rel="apple-touch-icon" href="assets/img/favicon/favicon-57.png">
	<link rel="apple-touch-icon" sizes="114x114" href="assets/img/favicon/favicon-114.png">
	<link rel="apple-touch-icon" sizes="72x72" href="assets/img/favicon/favicon-72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="assets/img/favicon/favicon-144.png">
	<link rel="apple-touch-icon" sizes="60x60" href="assets/img/favicon/favicon-60.png">
	<link rel="apple-touch-icon" sizes="120x120" href="assets/img/favicon/favicon-120.png">
	<link rel="apple-touch-icon" sizes="76x76" href="assets/img/favicon/favicon-76.png">
	<link rel="apple-touch-icon" sizes="152x152" href="assets/img/favicon/favicon-152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="assets/img/favicon/favicon-180.png">
	<meta name="msapplication-TileColor" content="#FFFFFF">
	<meta name="msapplication-TileImage" content="assets/img/favicon/favicon-144.png">
	<meta name="msapplication-config" content="assets/img/favicon/browserconfig.xml">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="description" content="The Elle Endless Learner Administrative Portal. UCF Senior Design, Fall 2017">
  <meta name="author" content="Eric Butt">
	<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
	<meta name="viewport" content="width=device-width" />
	<!--Font Awesome-->
	<link href='assets/css/font-awesome-4.7.0/fonts/montserrat.css' rel='stylesheet' type='text/css'>
	<link href="assets/css/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!--Bootstrap CSS-->
	<link  href="assets/css/bootstrap.min.css" rel="stylesheet"/>
	<!--Jquery-->
	<script src="assets/js/jquery-3.2.1.min.js" type="text/javascript"></script>
  <script src="assets/js/jquery-ui-1.12.1.custom.min.js" type="text/javascript"></script>
	<!--PaperKit Template-->
	<link href="assets/css/paper-kit-custom.min.css" rel="stylesheet"/>
	<script src="assets/js/particles.min.js" type="text/javascript"></script>
  <title>Login to ELLE</title>
  <link rel="stylesheet" href="stylesheets/index/login.css">
</head>
<body>
  
<div id="particlesBackground"></div>
<div id="overlay">
<img class="loginCenterpiece" src="assets/img/backgrounds/ELLE-Background-Black.png">

<!-- Start of Login Modal -->
  <div class="modal fade" id="login-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
			<div class="modal-content">
				<div id="top" class="modal-header" align="center">
				  <div class="closeButton">
  					<button type="button" class="close" id="closeButton" data-dismiss="modal" aria-label="Close">
  						<i class="fa fa-times" aria-hidden="true"></i>
  					</button>
				  </div>
				</div>
                
        <!-- Begin # DIV Form -->
        <div id="div-forms">
          <!-- Begin # Login Form -->
          <form id="login-form">
            <div class="modal-body">
              <div class="loginTitle text-center">
              </div>
      		    <div id="div-login-msg">
                <i id="icon-login-msg" class="fa fa-chevron-circle-right" aria-hidden="true"></i>
                <span id="text-login-msg">Login</span>
              </div>
              <div class="form-group">
                <label for="login_username" class="control-label">Username</label>
            		<input id="login_username" class="form-control" type="text" placeholder="username" required>
              </div>
              <div class="form-group">
                <label for="login_password" class="control-label">Password</label>
            		<input id="login_password" class="form-control" type="password" placeholder="password" required>
              </div>
          	</div>
            <div class="modal-footer">
              <div class="col-12">
                <div class="row">
                  <div class="col-10 offset-1">
                    <button type="submit" class="btn btn-primary btn-lg btn-block">Login</button>
                  </div>
          	      <div class="col-6">
                    <button id="login_lost_btn" type="button" class="btn btn-link">Recover</button>
                  </div>
                  <div class="col-6">
                    <button id="login_register_btn" type="button" class="btn btn-link">Register</button>
                  </div>
                </div>
              </div>
            </div>
          </form>
            <!-- End # Login Form -->
            
          <!-- Begin | Lost Password Form -->
          <form id="lost-form" style="display:none;">
  		      <div class="modal-body">
			      	<div id="div-lost-msg">
                <i id="icon-lost-msg" class="fa fa-chevron-circle-right" aria-hidden="true"></i>
                <span id="text-lost-msg">Recover your Password</span>
              </div>
              <div class="form-group">
      			    <label for="lost_username" class="control-label">Username</label>
      			    <input id="lost_username" class="form-control" type="text" placeholder="username" required autofocus>
      			    <label for="lost_email" class="control-label">Associated Email</label>
      			    <input id="lost_email" class="form-control" type="email" placeholder="email" required>
      			    <label for="lost_password_reset" class="control-label">Security Question</label>
      			    <a tabindex="0" type="button" class="refHelp" role="button" data-toggle="popover" data-trigger="focus" data-placement="top" title="Recovery Question" data-content="What was the name of your first pet?">
                  <i class="fa fa-question-circle" aria-hidden="true"></i>
                </a>
      			    <input id="lost_password_reset" class="form-control" type="password" placeholder="password" required>
      			    <label for="lost_password" class="control-label">New Password</label>
      			    <input id="lost_password" class="form-control" type="password" placeholder="password" required>
      			    <label for="lost_password_confirm" class="control-label">Confirm</label>
      			    <input id="lost_password_confirm" class="form-control" type="password" placeholder="password" required>
              </div>
      			</div>
  		      <div class="modal-footer">
  		        <div class="col-12">
    		        <div class="row">
                  <div class="col-10 offset-1">
                    <button type="submit" class="btn btn-primary btn-lg btn-block">Reset Password</button>
                  </div>
          	      <div class="col-6">
                    <button id="lost_login_btn" type="button" class="btn btn-link btn-lg">Log In</button>
                  </div>
                  <div class="col-6">
                    <button id="lost_register_btn" type="button" class="btn btn-link btn-lg">Register</button>
                  </div>
    		        </div>
              </div>
  		      </div>
          </form>
            <!-- End | Lost Password Form -->
            
            <!-- Begin | Register Form -->
          <form id="register-form" style="display:none;">
    		    <div class="modal-body">
				      <div id="div-register-msg">
                <i id="icon-register-msg" class="fa fa-chevron-circle-right" aria-hidden="true"></i>
                <span id="text-register-msg">Register an Account</span>
              </div>
              <div class="form-group">
                <label for="register_username" class="control-label">Username</label>
  				      <input id="register_username" class="form-control" type="text" placeholder="username" required>
              </div>
              <div class="form-group">
                <label for="register_email" class="control-label">Email</label>
                <input id="register_email" class="form-control" type="email" placeholder="email" required>
              </div>
              <label for="register_password_reset" class="control-label">Security Question</label>
      			    <a tabindex="0" type="button" class="refHelp" role="button" data-toggle="popover" data-trigger="focus" data-placement="top" title="Recovery Question" data-content="What was the name of your first pet?">
                  <i class="fa fa-question-circle" aria-hidden="true"></i>
                </a>
      			    <input id="register_password_reset" class="form-control" type="password" placeholder="password" required>
      			    
              <div class="form-group">
                <label for="register_password" class="control-label">Password</label>
                <input id="register_password" class="form-control" type="password" placeholder="password" required>
              </div>
              <div class="form-group">
                <label for="register_password_confirm" class="control-label">Confirm Password</label>
                <input id="register_password_confirm" class="form-control" type="password" placeholder="confirm password" required>
              </div>
    			    <div class="form-group">
                <label for ="register_referral" class='control-label'>Referring Admin</label>
                <a tabindex="0" type="button" class="refHelp" role="button" data-toggle="popover" data-trigger="focus" data-placement="top" title="Referral Admin" data-content="Only a current ELLE admin can approve your new account. Have a friend a sign you up!">
                  <i class="fa fa-question-circle" aria-hidden="true"></i>
                </a>
    			      <input id="register_referral" class="form-control" type="text" placeholder="referring username">
              </div>
    			  </div>
		        <div class="modal-footer">
		          <div class="col-12">
  		          <div class="row">
                  <div class="col-10 offset-1">
                    <button type="submit" class="btn btn-primary btn-lg btn-block">Register</button>
                  </div>
          	      <div class="col-6">
                    <button id="register_login_btn" type="button" class="btn btn-link">Log In</button>
                  </div>
                  <div class="col-6">
                    <button id="register_lost_btn" type="button" class="btn btn-link">Recovery</button>
                  </div>
  		          </div>
              </div>
		        </div>
          </form>
          <!-- End | Register Form -->
        </div>
        <!-- End # DIV Form -->
                
			</div>
		</div>
	</div>
    <!-- END # MODAL LOGIN -->
  </div>

</body>
  <!-- Core JS Files (jQuery is in beforeTitle-->
  <script src="assets/js/tether.min.js" type="text/javascript"></script>
  <script src="assets/js/popper.min.js" type="text/javascript"></script>
  <script src="assets/js/bootstrap.min.js" type="text/javascript"></script>
  <script src="assets/js/bootstrap-beta.min.js" type="text/javascript"></script>
  <!-- Switches -->
  <script src="assets/js/bootstrap-switch.min.js"></script>
  <script src="assets/js/paper-kit.js?v=2.0.1"></script>
  
<script>
  //  Options For Particles JS.
  //  Check out http://vincentgarreau.com/particles.js/ for source code/options
  var options = {
    "particles": {
      "number":{
        "value":120,
        "density":{
          "enable":true,
          "value_area":552.4033491425909}
        },
        "color":{
          "value":"#ffffff"
        },
        "shape":{
          "type":"circle",
          "stroke":{
            "width":0,
            "color":"#000000"
          },
          "polygon":{
            "nb_sides":3
          },
          "image":{
            "src":"img/github.svg",
            "width":70,
            "height":100}
        },
        "opacity":{
          "value":1,
          "random":true,
          "anim":{
            "enable":false,
            "speed":1,
            "opacity_min":0.1,
            "sync":false}
          },
          "size":{
            "value":3,
            "random":true,
            "anim":{
              "enable":true,
              "speed":3,
              "size_min":0.1,
              "sync":false}
          },
          "line_linked":{
            "enable":true,
            "distance":90,
            "color":"#ffffff",
            "opacity":0.45,
            "width":1
          },
          "move":{
            "enable":true,
            "speed":2.9782952832645452,
            "direction":"none",
            "random":true,
            "straight":false,
            "out_mode":"out",
            "bounce":false,
            "attract":{
              "enable":false,
              "rotateX":600,
              "rotateY":1200
            }
          }
    },
    "interactivity":{
      "detect_on":"canvas",
      "events":{
        "onhover":{
          "enable":false,
          "mode":"repulse"
        },
        "onclick":{
          "enable":true,
          "mode":"push"
        },
        "resize":true
      },
      "modes":{
        "grab":{
          "distance":400,
          "line_linked":{
            "opacity":1
          }
        },
        "bubble":{
          "distance":400,
          "size":40,
          "duration":2,
          "opacity":8,
          "speed":3
        },
        "repulse":{
          "distance":200,
          "duration":0.4
        },
        "push":{
          "particles_nb":4
        },
        "remove":{
          "particles_nb":2
        }
      }
    },
    "retina_detect":false
  };
  particlesJS("particlesBackground", options);
</script>

<script>

function scrollIntoView(eleID) {
   var e = document.getElementById(eleID);
   if (!!e && e.scrollIntoView) {
       e.scrollIntoView();
   }
}

$(function() {
  
  var users = [];
  
  $('#login-modal').modal({
    backdrop: 'static'
  });
  
  $('.loginCenterpiece').click(function(){
    $('#login-modal').modal({
      backdrop: 'static'
    });
    
  });
  
  $('#login-modal').on('shown.bs.modal', function(){
    $("#login_username").focus();
  });
  $('#login_username').keypress(function(event) {
    if (event.keyCode == 13 || event.which == 13) {
        $('#login_password').focus();
        event.preventDefault();
    }
  });
  $('#login_password').keypress(function(event){
    if (event.keyCode == 13 || event.which == 13){
      $('#login-form').submit();
    }
    
  });
  $('#lost_username').keypress(function(event) {
    if (event.keyCode == 13 || event.which == 13) {
        $('#lost_email').focus();
        event.preventDefault();
    }
  });
  $('#lost_email').keypress(function(event) {
    if (event.keyCode == 13 || event.which == 13) {
        $('#lost_password_reset').focus();
        event.preventDefault();
    }
  });
  $('#lost_password_reset').keypress(function(event) {
    if (event.keyCode == 13 || event.which == 13) {
        $('#lost_password').focus();
        event.preventDefault();
    }
  });
  $('#lost_password').keypress(function(event) {
    if (event.keyCode == 13 || event.which == 13) {
        $('#lost_password_confirm').focus();
        event.preventDefault();
    }
  });
  $('#lost_password_confirm').keypress(function(event) {
    if (event.keyCode == 13 || event.which == 13) {
        event.preventDefault();
        $("#lost-form").submit();
    }
  });
  $('#register_username').keypress(function(event) {
    if (event.keyCode == 13 || event.which == 13) {
        $('#register_email').focus();
        event.preventDefault();
    }
  });
  $('#register_email').keypress(function(event) {
    if (event.keyCode == 13 || event.which == 13) {
        $('#register_password').focus();
        event.preventDefault();
    }
  });
  $('#register_password').keypress(function(event) {
    if (event.keyCode == 13 || event.which == 13) {
        $('#register_password_confirm').focus();
        event.preventDefault();
    }
  });
  $('#register_password_confirm').keypress(function(event) {
    if (event.keyCode == 13 || event.which == 13) {
        $('#register_referral').focus();
        event.preventDefault();
    }
  });
  $('#register_referral').keypress(function(event){
    if (event.keyCode == 13 || event.which == 13){
      $('#register-form').submit();
    }
  });
  
  $('.popover-dismiss').popover({
    trigger: 'focus'
  })
    
  $('.refHelp').click(function(){
    $(this).popover();
  });
  
    var formLogin = $('#login-form');
    var formLost = $('#lost-form');
    var formRegister = $('#register-form');
    var divForms = $('#div-forms');
    var modalAnimateTime = 300;  //  How long it takes for the menu options to switch
    var msgAnimateTime = 150;    //  How long it takes for the message to update

    $('#login-form').submit(function(event){
      event.preventDefault();
      var userJSON = {
        'username': $('#login_username').val()
      };
      var userJSONreq = JSON.stringify(userJSON);

      var credentialsJSON = {
        'username': $('#login_username').val(),
        'password': $('#login_password').val()
      }
      var credentialsJSONreq = JSON.stringify(credentialsJSON);
      
      var auth = new XMLHttpRequest();
      auth.open("POST", 'http://159.203.163.147/auth', true);
      // auth.setRequestHeader('Access-Control-Allow-Methods', 'POST');
      auth.setRequestHeader("Content-Type", "application/json");
    
      auth.onreadystatechange = function () {
        if(auth.readyState == XMLHttpRequest.DONE && auth.status == 200) {
              //  If Auth succeeds, store the token and author name in session
              //  storage and redirect to the homepage.
              var response = JSON.parse(auth.responseText);
              sessionStorage.setItem('ELLE-JWT-token', response.access_token);
              sessionStorage.setItem('ELLE-author', $('#login_username').val());
              messageChange($('#div-login-msg'), $('#icon-login-msg'), $('#text-login-msg'), "success", "fa-check-square-o", "Login Accepted!");
              window.location = "/home";
              setTimeout(function() {
                window.location = "/home";
              }, 1750);
              
          }
          else if (auth.status == 401) {
            messageChange($('#div-login-msg'), $('#icon-login-msg'), $('#text-login-msg'), "error", "fa-exclamation-circle", "Invalid user or password");
          }
      }
      auth.send(credentialsJSONreq);
      
    });  //  End of login form submit
    
    $('#lost-form').submit(function(event){
      event.preventDefault();
      
      if ($("#lost_password").val() != $("#lost_password_confirm").val()){
        messageChange($('#div-lost-msg'), $('#icon-lost-msg'), $('#text-lost-msg'), "error", "fa-exclamation-circle", "Passwords do not match");
        return;
      }
      
      var lostUserJSON = {
        'username': $("#lost_username").val(),
        'password_reset' : $("#lost_password_reset").val(),
        'email': $("#lost_email").val(),
        'new_password': $("#lost_password").val()
      }
      var lostUserJSONreq = JSON.stringify(lostUserJSON);

      var resetPassword = new XMLHttpRequest();
      resetPassword.open("PUT", 'http://159.203.163.147/resetPassword', true);
      resetPassword.setRequestHeader('Authorization', 'JWT ' + sessionStorage.getItem('ELLE-JWT-token'));
      resetPassword.setRequestHeader('Content-Type', 'application/json');
      resetPassword.onreadystatechange = function () {
        if(resetPassword.readyState == XMLHttpRequest.DONE && resetPassword.status == 200) {
            // Let the user know their password has been reset
            messageChange($('#div-lost-msg'), $('#icon-lost-msg'), $('#text-lost-msg'), "success", "fa-check-square-o", "Password has been reset!");
            setTimeout(function() {
              $("#lost-login").click();
            }, 1000)
        }
        // else if (resetPassword.status == 400){
        //   messageChange($('#div-lost-msg'), $('#icon-lost-msg'), $('#text-lost-msg'), "error", "fa-exclamation-circle", "Invalid reset information");
        // }
        else {
          messageChange($('#div-register-msg'), $('#icon-register-msg'), $('#text-register-msg'), "error", "fa-exclamation-circle", "Invalid reset info");
        }
      }
      
      resetPassword.send(lostUserJSONreq);
      
    }); // End of reset for submit
    
    $('#register-form').submit(function(event){
        event.preventDefault();

        //  Don't submit until passwords match
        if ($('#register_password').val() != $('#register_password_confirm').val()){
          messageChange($('#div-register-msg'), $('#icon-register-msg'), $('#text-register-msg'), "error", "fa-exclamation-circle", "Passwords don't match");
          return;
        }
        
        var registerAdminJSON = {
          'username': $('#register_username').val(),
          'password': $('#register_password').val(),
          'email': $('#register_email').val(),
          'password_reset': $("#register_password_reset").val(),
          'sent_by': $('#register_referral').val()
        };
        
        var registerAdminJSONreq = JSON.stringify(registerAdminJSON);
        
        var registerAdmin = new XMLHttpRequest();
        registerAdmin.open("POST", 'http://159.203.163.147/pendingAdmin', true);
        registerAdmin.setRequestHeader('Content-Type', 'application/json');
        registerAdmin.onreadystatechange = function () {
          if(registerAdmin.readyState == XMLHttpRequest.DONE && registerAdmin.status == 200) {
              messageChange($('#div-register-msg'), $('#icon-register-msg'), $('#text-register-msg'), "success", "fa-check-square-o", "Register Request Sent!");
        
          }
          else if (registerAdmin.status == 400){
            var response = JSON.parse(registerAdmin.responseText);

            if (response.message == "An admin with that username already exists" ){
              messageChange($('#div-register-msg'), $('#icon-register-msg'), $('#text-register-msg'), "error", "fa-exclamation-circle", "Username already taken");
              document.getElementById("div-register-msg").scrollIntoView();
              return;
            }
            else if (response.message == "An admin with that email already exists" ){
              messageChange($('#div-register-msg'), $('#icon-register-msg'), $('#text-register-msg'), "error", "fa-exclamation-circle", "Email already in use");
              document.getElementById("div-register-msg").scrollIntoView();
              return;
            }
            else if (response.message == "This admin does not exist."){
              messageChange($('#div-register-msg'), $('#icon-register-msg'), $('#text-register-msg'), "error", "fa-exclamation-circle", "Unknown referral admin");
              document.getElementById("div-register-msg").scrollIntoView();
              return;
            }
          }
          else {
            messageChange($('#div-register-msg'), $('#icon-register-msg'), $('#text-register-msg'), "error", "fa-exclamation-circle", "Register Request Failed");
          }
        }

        registerAdmin.send(registerAdminJSONreq);
  
    }); // End of register form submit

    $('#login_register_btn').click( function () { 
      modalAnimate(formLogin, formRegister) 
      $('#register_username').focus();
    });
    $('#register_login_btn').click( function () { modalAnimate(formRegister, formLogin); });
    $('#login_lost_btn').click( function () { modalAnimate(formLogin, formLost); });
    $('#lost_login_btn').click( function () { modalAnimate(formLost, formLogin); });
    $('#lost_register_btn').click( function () { modalAnimate(formLost, formRegister); });
    $('#register_lost_btn').click( function () { modalAnimate(formRegister, formLost); });
    
    function modalAnimate (oldForm, newForm) {
        var oldH = oldForm.height();
        var newH = newForm.height();
        divForms.css("height",oldH);
        oldForm.fadeToggle(modalAnimateTime, function(){
            divForms.animate({height: newH}, modalAnimateTime, function(){
                newForm.fadeToggle(modalAnimateTime);
            });
        });
    }
    
    function msgFade (msgId, msgText) {
        msgId.fadeOut(msgAnimateTime, function() {
            $(this).text(msgText).fadeIn(msgAnimateTime);
        });
    }
    
    function messageChange(divTag, iconTag, textTag, newDivClass, newIconClass, msgText){
      msgFade(textTag, msgText);
      divTag.removeClass("success error");
      divTag.addClass(newDivClass);
      iconTag.removeClass("success error");
      iconTag.removeClass(function() {
        //  Regex is for font awesome classes (fa-{CLASSHERE})
        return (this.className.match(/\bfa-[\S]{1,}/g) || []).join(' ');
      });
      iconTag.addClass(newIconClass);
      iconTag.addClass(newIconClass + " " + newDivClass);
      
    }
});
</script>
  
</html>


